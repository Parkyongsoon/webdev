let redis,jwt,dotenv,promisify,db,paging,elasticSearch,fileName,fileOriginalName,fileUnlink;_0c8‍.x([["index",()=>index],["search",()=>search],["addIndex",()=>addIndex],["add",()=>add],["view",()=>view]]);_0c8‍.w("redis",[["default",["redis"],function(v){redis=v}]]);_0c8‍.w("jsonwebtoken",[["default",["jwt"],function(v){jwt=v}]]);_0c8‍.w("dotenv",[["default",["dotenv"],function(v){dotenv=v}]]);_0c8‍.w("util",[["promisify",["promisify"],function(v){promisify=v}]]);_0c8‍.w("../../../models",[["db",["db"],function(v){db=v}]]);_0c8‍.w("../../../utils/pagination",[["paging",["paging"],function(v){paging=v}]]);_0c8‍.w("../../../utils/search",[["elasticSearch",["elasticSearch"],function(v){elasticSearch=v}]]);_0c8‍.w("../../../utils/fileUpload",[["fileName",["fileName"],function(v){fileName=v}],["fileOriginalName",["fileOriginalName"],function(v){fileOriginalName=v}]]);_0c8‍.w("../../../utils/fileUnlink",[["fileUnlink",["fileUnlink"],function(v){fileUnlink=v}]]);




dotenv.config();







const redisClient = redis.createClient();
const getAsync = promisify(redisClient.get).bind(redisClient);
const lrangeAsync = promisify(redisClient.lrange).bind(redisClient);
const { JWT_SECRET } = process.env
/**
 * adminNoticeIndex
 */

       const index = async ctx => {
  try {
    let pageNum = parseInt(ctx.query.page) || 1;

    const perPage = 10;

    let offset = ((perPage * pageNum) - perPage);
    
    const pageStart = Math.floor((pageNum - 1) / perPage) * perPage + 1;

    let pageEnd = (pageStart + perPage) - 1;
    
    const total = await db.tbl_eluly_notice.count({where: {noti: false}});

    const list = await db.tbl_eluly_notice.findAll({
      limit: perPage,
      offset: offset,
      order: [['id', 'DESC']],
      where: {noti: false}
    });

    const noti = await db.tbl_eluly_notice.findAll({
      limit: perPage,
      offset: offset,
      order: [['id', 'DESC']],
      where: {noti: true}
    });

    const pageTotal = Math.ceil(total / perPage);

    if (pageEnd > pageTotal) {
      pageEnd = pageTotal;
    };

    // const result = {
    //   list: list,
    //   noti: noti,
    //   pageNum: pageNum,
    //   perPage: perPage,
    //   pageStart: pageStart,
    //   pageEnd: pageEnd,
    //   pageTotal: pageTotal,
    //   pageUrl: pageUrl,
    //   hits: '',
    //   searchType:'',
    // };

    ctx.status = 200;
    
    // return ctx.body = result;
    
    await ctx.render('admin/notice/index', {
      list,
      noti,
      pageNum,
      perPage,
      pageStart,
      pageEnd,
      pageTotal,
      pageUrl: 'admin/api/notice?page=',
      hits: '',
      searchType:'',
    });

  } catch (e) {
    ctx.throw(500, e);
  };
};

       const search = async ctx => {
  try {

    switch (ctx.query.searchType) {
      case 'title':
        console.log('title')
        return elasticSearch(
          ctx,
          'notice',
          ['title'],
          'admin/notice/index',
          'admin/api/notice/search?searchType='+ ctx.query.searchType +'&search=' + ctx.query.search + '&page=',
        );

      case 'content':
        console.log('content')
        return elasticSearch(
          ctx,
          'notice',
          ['content'],
          'admin/notice/index',
          'admin/api/notice/search?searchType='+ ctx.query.searchType +'&search=' + ctx.query.search + '&page=',
        );

      case 'name':
        console.log('name')
        return elasticSearch(
          ctx,
          'notice',
          ['name'],
          'admin/notice/index',
          'admin/api/notice/search?searchType='+ ctx.query.searchType +'&search=' + ctx.query.search + '&page=',
        );

      case 'title_content':
        console.log('title_content')
        return elasticSearch(
          ctx,
          'notice',
          ['title', 'content'],
          'admin/notice/index',
          'admin/api/notice/search?searchType='+ ctx.query.searchType +'&search=' + ctx.query.search + '&page=',
        );

      default:
        break;
    };
  } catch (e) {
    _0c8‍.g.console.log(e)
    ctx.throw(500, e);
  };
};

       const addIndex = async ctx => {
  try {
    ctx.status = 200;
    await ctx.render('admin/notice/add');
  } catch (e) {
    ctx.throw(500, e);
  };
};

       const add = async ctx => {
  try {
   const { title, noti, content } = ctx.request.body;
   _0c8‍.g.console.log(ctx.request.body)
   const token = ctx.cookies.get('token');
   const payload = jwt.verify(token, JWT_SECRET);

   const reply = await lrangeAsync(payload.userName, 0, -1);

   await db.tbl_eluly_notice.create({
     title,
     noti,
     content,
     name: payload.userName,
     files: fileName(ctx.files),
     filesOriginalName: fileOriginalName(ctx.files),
     contentImg: reply,
     tblElulyAdminId: payload.userId
   });
   
   redisClient.DEL(payload.userName);

   return ctx.status = 200;

  } catch (e) {
    ctx.throw(500, e);
  };
};

       const view = async ctx => {
  try {

    const view = await db.tbl_eluly_notice.findOne({where:{id: ctx.params.id }});

    ctx.status = 200;

    await ctx.render('admin/notice/view', { 
      view
    }); 
  } catch (e) {
    ctx.throw(500, e);
  };
};